name: Deploy to GitHub Pages

on:
  release:
    types: [published]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é —Ä–µ–ª–∏–∑–∞
      - name: Get release version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      # –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # –®–∞–≥ 4: –ö–ª–æ–Ω–∏—Ä—É–µ–º –≤–µ—Ç–∫—É gh-pages
      - name: Clone gh-pages
        run: |
          git clone -b gh-pages https://github.com/${{ github.repository }}.git gh-pages-temp

      # –®–∞–≥ 5: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
      - name: Create version folder
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
          mkdir -p "gh-pages-temp/v$VERSION"
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
          cp -r index.html ru en "gh-pages-temp/v$VERSION/"
          
          # –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ä—Å–∏—é (latest)
          cp -r index.html ru en "gh-pages-temp/"

      # –®–∞–≥ 6: –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      - name: Update versions list
        run: |
          cd gh-pages-temp
          
          # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–∞–ø–∫–∏ –≤–µ—Ä—Å–∏–π
          VERSIONS=$(find . -maxdepth 1 -name "v*" -type d | sort -rV)
          
          # –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
          VERSION_HTML=""
          for version_dir in $VERSIONS; do
            if [ "$version_dir" != "." ]; then
              version_name=$(basename $version_dir)
              VERSION_HTML="$VERSION_HTML<li><a href=\"${version_dir}/index.html\">–í–µ—Ä—Å–∏—è ${version_name}</a></li>"
            fi
          done
          
          # –û–±–Ω–æ–≤–ª—è–µ–º index.html
          sed -i 's|<ul id="versions-list">.*</ul>|<ul id="versions-list">'"$VERSION_HTML"'</ul>|' index.html
          
          echo "Updated versions list:"
          echo "$VERSION_HTML"

      # –®–∞–≥ 7: –ü—É–±–ª–∏–∫—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ gh-pages
      - name: Deploy to gh-pages
        run: |
          cd gh-pages-temp
          git add .
          git commit -m "Deploy version $VERSION and update versions list"
          git push

      # –®–∞–≥ 8: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏
      - name: Show deployment info
        run: |
          echo "üöÄ –í–µ—Ä—Å–∏—è $VERSION —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!"
          echo "üì± –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "üîó –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/v$VERSION/"