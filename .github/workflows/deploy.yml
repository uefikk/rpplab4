name: Deploy to GitHub Pages

on:
  release:
    types: [created]
  push:
    branches: [main, master]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
      - name: Detect branch info
        id: branch_info
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∞—è –≤–µ—Ç–∫–∞ –æ—Å–Ω–æ–≤–Ω–∞—è
          if git show-ref --verify --quiet refs/heads/main; then
            echo "branch=main" >> $GITHUB_OUTPUT
          elif git show-ref --verify --quiet refs/heads/master; then
            echo "branch=master" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup gh-pages branch
        run: |
          # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ gh-pages
          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
            git pull origin gh-pages
          else
            git checkout --orphan gh-pages
            git reset --hard
          fi
      
      - name: Deploy files
        run: |
          TAG="${{ steps.branch_info.outputs.tag }}"
          IS_RELEASE="${{ steps.branch_info.outputs.is_release }}"
          SOURCE_BRANCH="${{ steps.branch_info.outputs.branch }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          echo "üöÄ Deploying: $TAG"
          echo "üìÇ Source branch: $SOURCE_BRANCH"
          echo "üè∑Ô∏è Is release: $IS_RELEASE"
          
          # –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É (–∫—Ä–æ–º–µ .git)
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} + 2>/dev/null || true
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π –≤–µ—Ç–∫–∏
          git checkout $SOURCE_BRANCH -- .
          
          if [ "$IS_RELEASE" == "true" ]; then
            echo "üì¶ Creating versioned release: $TAG"
            
            # –°–æ–∑–¥–∞–µ–º –≤–µ—Ä—Å–∏–æ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            mkdir -p "$REPO_NAME/$TAG"
            
            # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã —Å–∞–π—Ç–∞
            cp -r *.html "$REPO_NAME/$TAG/" 2>/dev/null || true
            cp -r ru en "$REPO_NAME/$TAG/" 2>/dev/null || true
            
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∏–Ω–¥–µ–∫—Å –≤–µ—Ä—Å–∏–π
            cat > "$REPO_NAME/index.html" << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>Versions - $REPO_NAME</title>
              <style>
                  body { font-family: Arial; max-width: 600px; margin: 50px auto; padding: 20px; }
                  h1 { color: #333; }
                  ul { list-style: none; padding: 0; }
                  li { margin: 10px 0; }
                  a { color: #007acc; text-decoration: none; }
                  a:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <h1>Available Versions</h1>
              <ul>
                  <li>‚Ä¢ <a href="$TAG/">Version $TAG</a></li>
              </ul>
          </body>
          </html>
          EOF
                      
                    git add "$REPO_NAME"
                    fi
                    
                    # –£–¥–∞–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –¥–µ–ø–ª–æ—è
                    rm -rf .github 2>/dev/null || true
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    git add .
                    
                    # –ö–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    if ! git diff --staged --quiet; then
                      git commit -m "Deploy $TAG [$(date +'%Y-%m-%d %H:%M')]"
                      git push origin gh-pages
                      echo "‚úÖ Successfully deployed $TAG"
                    else
                      echo "‚ÑπÔ∏è No changes to deploy"
                    fi