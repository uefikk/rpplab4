name: Deploy to GitHub Pages

on:
  release:
    types: [published]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é —Ä–µ–ª–∏–∑–∞
      - name: Get release version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      # –®–∞–≥ 3: –ö–ª–æ–Ω–∏—Ä—É–µ–º –≤–µ—Ç–∫—É gh-pages —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏
      - name: Setup gh-pages
        run: |
          git fetch origin gh-pages
          git worktree add ./gh-pages gh-pages

      # –®–∞–≥ 4: –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
      - name: Create build structure
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ gh-pages
          if [ -d "gh-pages/v$VERSION" ]; then
            rm -rf gh-pages/v$VERSION
          fi
          
          # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
          mkdir -p "gh-pages/v$VERSION"
          cp -r index.html ru en "gh-pages/v$VERSION/"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ —Å–ø–∏—Å–∫–æ–º –≤–µ—Ä—Å–∏–π
          cp index.html ru en gh-pages/

      # –®–∞–≥ 5: –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      - name: Update versions navigation
        run: |
          cd gh-pages
          
          # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –≤–µ—Ä—Å–∏–∏ –∏ —Å–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫
          VERSIONS=$(find . -maxdepth 1 -name "v*" -type d | sort -rV)
          
          # –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
          VERSION_HTML="<h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏:</h2><ul>"
          for version_dir in $VERSIONS; do
            if [ "$version_dir" != "." ]; then
              version_name=$(basename $version_dir)
              VERSION_HTML="$VERSION_HTML<li><a href=\"${version_dir}/index.html\">–í–µ—Ä—Å–∏—è ${version_name}</a></li>"
            fi
          done
          VERSION_HTML="$VERSION_HTML</ul>"
          
          # –í—Å—Ç–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –≤ index.html
          sed -i '/<ul id="versions-list">/,/<\/ul>/c\<ul id="versions-list">'"$VERSION_HTML"'</ul>' index.html

      # –®–∞–≥ 6: –ü—É–±–ª–∏–∫—É–µ–º –≤ GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          keep_files: true
          force_orphan: false

      # –®–∞–≥ 7: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –¥–µ–ø–ª–æ–π
      - name: Show deployment URL
        run: |
          echo "üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!"
          echo "üì± –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "üîó –í–µ—Ä—Å–∏—è $VERSION: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/v$VERSION/"