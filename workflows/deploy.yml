name: Deploy to GitHub Pages

on:
  release:
    types: [created]
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
      - name: Setup gh-pages
        run: |
          # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —á–∏—Å—Ç—É—é gh-pages –≤–µ—Ç–∫—É
          git checkout --orphan gh-pages-new
          git reset --hard
          
      - name: Deploy
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–µ–ø–ª–æ—è
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            IS_RELEASE=true
          else
            TAG="latest"
            IS_RELEASE=false
          fi
          
          REPO_NAME="${{ github.repository }}"
          REPO_NAME=${REPO_NAME#*/}  # –£–±–∏—Ä–∞–µ–º username/
          
          echo "üöÄ Deploying: $TAG"
          echo "üì¶ Is release: $IS_RELEASE"
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑ main –≤–µ—Ç–∫–∏
          git checkout main -- .
          
          if [ "$IS_RELEASE" == "true" ]; then
            # –î–ª—è —Ä–µ–ª–∏–∑–∞ —Å–æ–∑–¥–∞–µ–º –≤–µ—Ä—Å–∏–æ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            mkdir -p "versions/$TAG"
            cp -r * "versions/$TAG/" 2>/dev/null || true
            
            # –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –≤–µ—Ä—Å–∏–π
            cat > "versions/index.html" << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>–í–µ—Ä—Å–∏–∏ —Å–∞–π—Ç–∞</title>
              <style>
                  body { font-family: Arial; max-width: 600px; margin: 50px auto; padding: 20px; }
                  h1 { color: #333; }
                  a { color: #007acc; text-decoration: none; }
                  a:hover { text-decoration: underline; }
                  .version { margin: 10px 0; padding: 10px; background: #f5f5f5; }
              </style>
          </head>
          <body>
              <h1>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏</h1>
              <div id="versions"></div>
              <script>
                  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏–º –≤–µ—Ä—Å–∏–∏
                  fetch('.')
                      .then(r => r.text())
                      .then(html => {
                          const parser = new DOMParser();
                          const doc = parser.parseFromString(html, 'text/html');
                          const links = Array.from(doc.querySelectorAll('a'))
                              .map(a => a.href)
                              .filter(href => href && !href.includes('index.html'))
                              .map(href => href.replace(/\/$/, ''));
                          
                          const container = document.getElementById('versions');
                          if (links.length === 0) {
                              container.innerHTML = '<p>–í–µ—Ä—Å–∏–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>';
                          } else {
                              links.forEach(version => {
                                  const div = document.createElement('div');
                                  div.className = 'version';
                                  div.innerHTML = `<a href="${version}/">üöÄ ${version}</a>`;
                                  container.appendChild(div);
                              });
                          }
                      });
              </script>
          </body>
          </html>
          EOF
                    fi
                    
                    # –£–¥–∞–ª—è–µ–º CI —Ñ–∞–π–ª—ã –∏–∑ –¥–µ–ø–ª–æ—è
                    rm -rf .github
                    
                    # –ö–æ–º–º–∏—Ç–∏–º –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—É—à–∏–º
                    git add .
                    git commit -m "Deploy $TAG"
                    git push origin gh-pages-new:gh-pages --force
                    echo "üéâ Deployed successfully!"